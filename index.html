<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mtaani Wifi Hub | Global Admin Sync</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1c1917; color: #d6d3d1; margin: 0; overflow-x: hidden; }
        .glass-card { background: rgba(41, 37, 36, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(120, 53, 15, 0.15); }
        .active-tab { border-bottom: 3px solid #78350f; color: #fff !important; }
        .hidden { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1c1917; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #78350f; border-radius: 10px; }
        @keyframes pulse-sync { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.5; } }
        .sync-active { animation: pulse-sync 1.5s infinite; color: #22c55e; }
        .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="custom-scroll min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-[#1c1917]/95 backdrop-blur-md border-b border-[#44403c]">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-[#78350f] rounded-xl shadow-lg shadow-orange-900/20">
                    <i data-lucide="zap" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <span class="text-xl font-black italic tracking-tighter uppercase block leading-none">Mtaani Wifi</span>
                    <span id="header-sync-id" class="text-[8px] font-bold text-[#78350f] tracking-[0.2em] uppercase opacity-70">Cloud Sync Active</span>
                </div>
            </div>
            <div class="flex gap-4 md:gap-8">
                <button onclick="switchTab('portal')" id="nav-portal" class="text-[10px] md:text-xs font-black uppercase tracking-widest py-7 opacity-50 hover:opacity-100 transition-all">Portal</button>
                <button onclick="switchTab('admin')" id="nav-admin" class="text-[10px] md:text-xs font-black uppercase tracking-widest py-7 opacity-50 hover:opacity-100 transition-all">Admin Dashboard</button>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 md:p-8">
        
        <!-- CUSTOMER PORTAL -->
        <div id="view-portal" class="space-y-12 pb-20 animate-in fade-in slide-in-from-bottom-4 duration-700">
            <header class="text-center md:text-left space-y-4 pt-10">
                <h1 class="text-5xl md:text-8xl font-black uppercase tracking-tighter italic leading-[0.85]">Internet Bila<br><span class="text-[#78350f]">Mipaka Mtaani.</span></h1>
                <p class="text-[#a8a29e] text-lg max-w-xl font-medium">Lipa kidogo, peruzi sana. Huduma yetu sasa inapatikana Cloud masaa 24.</p>
                <div class="flex items-center gap-3 justify-center md:justify-start">
                    <div class="flex -space-x-2">
                        <div class="w-6 h-6 rounded-full bg-orange-600 border-2 border-[#1c1917]"></div>
                        <div class="w-6 h-6 rounded-full bg-orange-800 border-2 border-[#1c1917]"></div>
                        <div class="w-6 h-6 rounded-full bg-orange-400 border-2 border-[#1c1917]"></div>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-[#78350f]">+140 Active Users Today</span>
                </div>
            </header>

            <!-- Plans -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Plan 1 -->
                <div onclick="openPayModal('Lite', 500)" class="glass-card p-10 rounded-[2.5rem] border-2 border-transparent hover:border-[#78350f] hover:bg-[#78350f]/5 transition-all group cursor-pointer relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-lucide="ticket" class="w-32 h-32"></i>
                    </div>
                    <div class="flex justify-between items-start mb-8">
                        <i data-lucide="ticket" class="w-10 h-10 text-[#78350f]"></i>
                        <span class="bg-[#78350f] text-[10px] font-black px-4 py-1 rounded-full uppercase">Saa 6</span>
                    </div>
                    <h3 class="text-3xl font-black uppercase mb-2 tracking-tight">Daily Lite</h3>
                    <p class="text-[10px] text-[#a8a29e] mb-6 uppercase font-bold tracking-widest">WhatsApp & Browsing</p>
                    <div class="text-4xl font-black mb-8">Tsh 500</div>
                    <button class="w-full py-5 bg-[#44403c] group-hover:bg-[#78350f] rounded-2xl font-black uppercase text-xs tracking-widest transition-all">Nunua Sasa</button>
                </div>

                <!-- Plan 2 (Popular) -->
                <div onclick="openPayModal('Pro', 1000)" class="glass-card p-10 rounded-[2.5rem] border-2 border-[#78350f]/40 bg-[#78350f]/5 hover:scale-[1.03] transition-all group cursor-pointer relative overflow-hidden">
                    <div class="absolute right-6 top-6">
                        <span class="bg-green-500 text-black text-[8px] font-black px-3 py-1 rounded-full uppercase">Inapendwa Sana</span>
                    </div>
                    <div class="flex justify-between items-start mb-8">
                        <i data-lucide="zap" class="w-10 h-10 text-[#78350f]"></i>
                        <span class="bg-[#78350f] text-[10px] font-black px-4 py-1 rounded-full uppercase">Saa 24</span>
                    </div>
                    <h3 class="text-3xl font-black uppercase mb-2 tracking-tight">Daily Pro</h3>
                    <p class="text-[10px] text-[#a8a29e] mb-6 uppercase font-bold tracking-widest">Streaming & YouTube</p>
                    <div class="text-4xl font-black mb-8">Tsh 1,000</div>
                    <button class="w-full py-5 bg-[#78350f] rounded-2xl font-black uppercase text-xs tracking-widest transition-all shadow-xl shadow-orange-900/30">Nunua Sasa</button>
                </div>

                <!-- Plan 3 -->
                <div onclick="openPayModal('Weekly', 5000)" class="glass-card p-10 rounded-[2.5rem] border-2 border-transparent hover:border-[#78350f] hover:bg-[#78350f]/5 transition-all group cursor-pointer relative overflow-hidden">
                    <div class="flex justify-between items-start mb-8">
                        <i data-lucide="shield-check" class="w-10 h-10 text-[#78350f]"></i>
                        <span class="bg-[#78350f] text-[10px] font-black px-4 py-1 rounded-full uppercase">Siku 7</span>
                    </div>
                    <h3 class="text-3xl font-black uppercase mb-2 tracking-tight">Weekly Pro</h3>
                    <p class="text-[10px] text-[#a8a29e] mb-6 uppercase font-bold tracking-widest">Biashara & Heavy Use</p>
                    <div class="text-4xl font-black mb-8">Tsh 5,000</div>
                    <button class="w-full py-5 bg-[#44403c] group-hover:bg-[#78350f] rounded-2xl font-black uppercase text-xs tracking-widest transition-all">Nunua Sasa</button>
                </div>
            </div>

            <!-- Connection Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center pt-12 border-t border-[#44403c]">
                <div class="glass-card p-12 rounded-[3.5rem] space-y-8 relative overflow-hidden">
                    <div class="absolute -left-10 -bottom-10 opacity-5">
                        <i data-lucide="wifi" class="w-64 h-64"></i>
                    </div>
                    <h2 class="text-2xl font-black uppercase flex items-center gap-4 italic"><i data-lucide="key" class="text-[#78350f]"></i> Weka Code Yako</h2>
                    <input id="voucher-input" type="text" placeholder="CODE-HAPA" class="w-full bg-[#1c1917] border-2 border-[#44403c] rounded-[2.5rem] py-10 px-4 text-center text-4xl font-mono text-white focus:border-[#78350f] outline-none uppercase tracking-[0.2em] shadow-2xl">
                    <button onclick="simulateConnect()" id="btn-connect" class="w-full py-6 bg-[#78350f] rounded-[2.5rem] font-black text-xl uppercase tracking-widest hover:bg-[#92400e] transition-all shadow-xl shadow-orange-900/40">Unganisha Internet</button>
                </div>
                <div class="space-y-8 px-4">
                    <div class="space-y-2">
                        <h3 class="text-2xl font-black uppercase italic">Jinsi ya Kujiunga:</h3>
                        <p class="text-xs text-[#78350f] font-bold uppercase tracking-widest">Hatua 3 Tu Kuanza Peruzi</p>
                    </div>
                    <div class="space-y-6">
                        <div class="flex gap-6 items-start">
                            <div class="w-12 h-12 rounded-2xl bg-[#78350f]/10 border border-[#78350f]/30 flex items-center justify-center text-[#78350f] font-black text-xl shrink-0">1</div>
                            <div>
                                <h4 class="font-black uppercase text-sm mb-1">Chagua Ofa</h4>
                                <p class="text-xs text-[#a8a29e]">Bonyeza kifurushi unachotaka hapo juu kulingana na mahitaji yako.</p>
                            </div>
                        </div>
                        <div class="flex gap-6 items-start">
                            <div class="w-12 h-12 rounded-2xl bg-[#78350f]/10 border border-[#78350f]/30 flex items-center justify-center text-[#78350f] font-black text-xl shrink-0">2</div>
                            <div>
                                <h4 class="font-black uppercase text-sm mb-1">Lipia & Agiza</h4>
                                <p class="text-xs text-[#a8a29e]">Tuma fedha kwenda namba itakayotokea, kisha jaza jina lako na utume ombi.</p>
                            </div>
                        </div>
                        <div class="flex gap-6 items-start">
                            <div class="w-12 h-12 rounded-2xl bg-[#78350f]/10 border border-[#78350f]/30 flex items-center justify-center text-[#78350f] font-black text-xl shrink-0">3</div>
                            <div>
                                <h4 class="font-black uppercase text-sm mb-1">Pata Vocha</h4>
                                <p class="text-xs text-[#a8a29e]">Utatumiwa Code kwa SMS. Iweke hapa na uanze kufurahia kasi ya ajabu.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="view-admin" class="hidden space-y-8 animate-in fade-in zoom-in duration-500 pt-10">
            <!-- Lock Screen -->
            <div id="admin-lock" class="max-w-md mx-auto glass-card p-12 rounded-[3.5rem] space-y-8 border-2 border-[#78350f]/20">
                <div class="text-center space-y-2">
                    <div class="w-20 h-20 bg-[#78350f]/10 rounded-3xl mx-auto flex items-center justify-center border border-[#78350f]/30">
                        <i data-lucide="cloud-lightning" class="w-10 h-10 text-[#78350f]"></i>
                    </div>
                    <h2 class="text-2xl font-black uppercase italic tracking-tight">Global Hub Access</h2>
                    <p class="text-[10px] text-[#a8a29e] font-black uppercase tracking-widest">Data zako popote ulipo duniani</p>
                </div>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase px-2 text-[#78350f] tracking-[0.2em]">Biashara Sync ID</label>
                        <input id="admin-sync-id" type="text" placeholder="MFANO: MTAANI-WIFI-01" class="w-full bg-[#1c1917] border-2 border-[#44403c] p-5 rounded-2xl outline-none focus:border-[#78350f] text-center font-black uppercase tracking-widest shadow-inner">
                        <p class="text-[8px] text-[#44403c] px-2 uppercase font-bold text-center">Tumia ID hii kwenye vifaa vyako vyote kuona data sawa.</p>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase px-2 text-[#78350f] tracking-[0.2em]">Password</label>
                        <input id="admin-pass" type="password" placeholder="••••••••" class="w-full bg-[#1c1917] border-2 border-[#44403c] p-5 rounded-2xl outline-none focus:border-[#78350f] text-center font-bold">
                    </div>
                </div>
                <button onclick="loginAdmin()" class="w-full py-6 bg-[#78350f] rounded-2xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-all shadow-xl shadow-orange-900/20">Sync & Explore Dashboard</button>
            </div>

            <!-- Main Admin Content -->
            <div id="admin-content" class="hidden space-y-10">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                    <div class="space-y-2">
                        <div class="flex items-center gap-4">
                            <h2 class="text-5xl font-black uppercase italic tracking-tighter leading-none">Global Dashboard</h2>
                            <div class="flex items-center gap-2 bg-green-500/10 px-4 py-2 rounded-full border border-green-500/20">
                                <div id="sync-dot" class="w-2 h-2 rounded-full bg-green-500"></div>
                                <span class="text-[9px] font-black uppercase text-green-500 tracking-widest">Cloud Online</span>
                            </div>
                        </div>
                        <p id="ai-insight" class="text-[10px] font-mono text-[#78350f] font-bold uppercase tracking-tight">AI Diagnostic: Systems 100% Operational...</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="copyCustomerLink()" class="flex items-center gap-2 px-6 py-4 bg-[#78350f]/10 border border-[#78350f]/30 text-[#78350f] rounded-2xl hover:bg-[#78350f] hover:text-white transition-all">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            <span class="text-[10px] font-black uppercase">Copy Customer Link</span>
                        </button>
                        <button onclick="logoutAdmin()" class="p-4 bg-red-900/10 text-red-500 border border-red-500/20 rounded-2xl hover:bg-red-500 hover:text-white transition-all">
                            <i data-lucide="power" class="w-5 h-5"></i>
                        </button>
                    </div>
                </header>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-10 rounded-[2.5rem] border border-[#44403c]/30">
                        <div class="text-[10px] uppercase font-black text-[#44403c] mb-3 flex items-center gap-2 tracking-widest"><i data-lucide="trending-up" class="w-3 h-3"></i> Total Revenue</div>
                        <div id="stat-revenue" class="text-3xl font-black tracking-tighter text-white">Tsh 0</div>
                    </div>
                    <div class="glass-card p-10 rounded-[2.5rem] border border-[#44403c]/30">
                        <div class="text-[10px] uppercase font-black text-[#44403c] mb-3 flex items-center gap-2 tracking-widest"><i data-lucide="clock" class="w-3 h-3"></i> Pending Requests</div>
                        <div id="stat-pending" class="text-3xl font-black tracking-tighter text-[#78350f]">0</div>
                    </div>
                    <div class="glass-card p-10 rounded-[2.5rem] border-2 border-[#78350f]/20 bg-[#78350f]/5">
                        <div class="text-[10px] uppercase font-black text-[#78350f] mb-3 flex items-center gap-2 tracking-widest"><i data-lucide="globe" class="w-3 h-3"></i> Current Sync ID</div>
                        <div id="display-sync-id" class="text-2xl font-black tracking-tighter text-white uppercase truncate">NONE</div>
                    </div>
                    <div class="glass-card p-10 rounded-[2.5rem] border border-[#44403c]/30">
                        <div class="text-[10px] uppercase font-black text-[#44403c] mb-3 flex items-center gap-2 tracking-widest"><i data-lucide="zap" class="w-3 h-3"></i> Router Status</div>
                        <div class="text-3xl font-black tracking-tighter text-green-500 flex items-center gap-2">ACTIVE <span class="text-[10px] font-mono text-green-500/50">192.168.88.1</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Live Requests Table -->
                    <div class="xl:col-span-2 glass-card rounded-[3rem] overflow-hidden border border-[#44403c]/30">
                        <div class="p-8 border-b border-[#44403c]/30 flex justify-between items-center bg-[#1c1917]/50">
                            <div class="flex items-center gap-3">
                                <h3 class="font-black uppercase text-sm italic">Maombi Yote ya Mteja (Live)</h3>
                                <span id="sync-spinner" class="text-[#78350f] hidden"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[8px] font-black text-green-500 bg-green-500/10 px-3 py-1 rounded-full uppercase border border-green-500/20">Synced via Cloud</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto min-h-[400px]">
                            <table class="w-full text-left">
                                <thead class="bg-[#1c1917]/50 text-[10px] uppercase font-black text-[#44403c] border-b border-[#44403c]/20">
                                    <tr>
                                        <th class="px-10 py-6">Maelezo ya Mteja</th>
                                        <th class="px-10 py-6">Kifurushi / Bei</th>
                                        <th class="px-10 py-6 text-center">Kitendo</th>
                                    </tr>
                                </thead>
                                <tbody id="request-list" class="divide-y divide-[#44403c]/20">
                                    <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Side Tools -->
                    <div class="space-y-8">
                        <div class="glass-card p-10 rounded-[3rem] space-y-8 border border-[#44403c]/30">
                            <h3 class="font-black uppercase text-sm italic flex items-center gap-3"><i data-lucide="terminal" class="text-[#78350f]"></i> MikroTik Config</h3>
                            <div class="bg-black/50 p-6 rounded-2xl border border-[#44403c]/50 font-mono text-[11px] text-green-400/80 overflow-x-auto leading-relaxed shadow-inner">
                                <pre id="script-box">/ip hotspot user add name=USER password=PASS profile=mtaani</pre>
                            </div>
                            <button onclick="copyScript()" class="w-full py-5 bg-[#44403c] hover:bg-[#78350f] text-white rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg">Nakili Config Script</button>
                        </div>
                        
                        <div class="bg-[#78350f] p-10 rounded-[3rem] shadow-2xl space-y-4 relative overflow-hidden group">
                            <div class="absolute -right-8 -bottom-8 opacity-10 rotate-12 group-hover:scale-110 group-hover:rotate-0 transition-all duration-700">
                                <i data-lucide="shield" class="w-48 h-48"></i>
                            </div>
                            <h3 class="font-black uppercase text-lg text-white italic">Cloud Security</h3>
                            <p class="text-xs text-orange-100/70 font-medium leading-relaxed">Data zako sashed (James, Juma, etc) sasa ziko salama kwenye Cloud. Hata ukibadilisha simu au kompyuta, data zako zinafata ID yako ya biashara.</p>
                            <div class="pt-4 flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-orange-300 animate-pulse"></div>
                                <span class="text-[9px] font-black uppercase text-white tracking-widest">End-to-End Synced</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Payment Modal -->
    <div id="modal-pay" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl animate-in fade-in duration-300">
        <div class="w-full max-w-lg glass-card rounded-[3.5rem] overflow-hidden shadow-2xl border border-[#78350f]/30">
            <div class="p-10 bg-[#1c1917]/80 border-b border-[#44403c]/50 flex justify-between items-center">
                <div class="space-y-1">
                    <h3 class="font-black uppercase text-2xl italic tracking-tighter text-white">Lipa Internet Sasa</h3>
                    <p class="text-[10px] text-[#78350f] font-black uppercase tracking-widest">Hatua ya mwisho kujiunga</p>
                </div>
                <button onclick="closePayModal()" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-[#44403c]/30 text-[#44403c] hover:bg-red-500 hover:text-white transition-all shadow-lg"><i data-lucide="x"></i></button>
            </div>
            <div class="p-12 space-y-10 text-center">
                <div class="space-y-4 bg-[#78350f]/5 p-8 rounded-3xl border border-[#78350f]/20">
                    <p class="text-[10px] uppercase font-black text-[#a8a29e] tracking-[0.3em]">Tuma Kiasi cha <span id="pay-amount" class="text-white text-lg">0</span> Kwenda:</p>
                    <div class="text-5xl font-black text-[#78350f] font-mono tracking-tighter">0779 231 924</div>
                    <div class="flex flex-col items-center">
                        <p class="text-xs font-black uppercase text-white tracking-widest">JAPHET SUNDAY</p>
                        <p class="text-[9px] text-[#44403c] uppercase font-bold">Mtaani Wifi Authorized Admin</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="user-name" type="text" placeholder="JINA LAKO LA MPESA" class="w-full bg-[#1c1917] border-2 border-[#44403c] p-6 rounded-2xl outline-none focus:border-[#78350f] text-sm font-black uppercase shadow-inner text-center">
                        <input id="user-phone" type="tel" placeholder="NAMBA YAKO YA SIMU" class="w-full bg-[#1c1917] border-2 border-[#44403c] p-6 rounded-2xl outline-none focus:border-[#78350f] text-sm font-black font-mono shadow-inner text-center">
                    </div>
                    <button onclick="submitRequest()" id="btn-submit-req" class="w-full py-7 bg-[#78350f] rounded-[2.5rem] font-black uppercase tracking-[0.2em] text-white hover:bg-[#92400e] transition-all shadow-2xl shadow-orange-900/40 relative overflow-hidden group">
                        <span class="relative z-10">TUMA OMBI LA VOCHA</span>
                        <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                    </button>
                    <p class="text-[9px] text-[#44403c] font-bold uppercase">UKISHABONYEZA, SUBIRI SEKUNDE 5 ADMIN AHAKIKI</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP LOGIC -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^1.38.0"
      }
    }
    </script>
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // CONFIG: Key and Cloud Bucket
        const SYNC_BUCKET = "mtaani_cloud_sync_v3"; // Versioned to avoid old data conflicts
        const API_BASE = `https://kvdb.io/${SYNC_BUCKET}/`;

        let state = {
            currentTab: 'portal',
            requests: [],
            vouchers: [],
            isAdmin: sessionStorage.getItem('admin_logged') === 'true',
            syncId: new URLSearchParams(window.location.search).get('sid') || localStorage.getItem('last_sync_id') || 'MTAANI-DEFAULT',
            selectedPlan: null,
            isSyncing: false
        };

        // Initialize UI with current Sync ID
        document.getElementById('header-sync-id').innerText = `ID: ${state.syncId}`;

        // --- GLOBAL CLOUD SYNC ---
        // Enhanced to merge data safely (No overwrites of others' requests)
        async function syncData(mode = 'pull') {
            if (!state.syncId) return;
            state.isSyncing = true;
            
            const spinner = document.getElementById('sync-spinner');
            const syncDot = document.getElementById('sync-dot');
            if (spinner) spinner.classList.remove('hidden');
            if (syncDot) syncDot.classList.add('sync-active');

            try {
                if (mode === 'push') {
                    // Always pull first to get current world state
                    const res = await fetch(`${API_BASE}${state.syncId}`);
                    let cloudData = { requests: [], vouchers: [] };
                    if (res.ok) cloudData = await res.json();

                    // Merge local requests into cloud data (prevent duplicates by ID)
                    const existingIds = new Set(cloudData.requests.map(r => r.id));
                    state.requests.forEach(r => {
                        if (!existingIds.has(r.id)) cloudData.requests.unshift(r);
                    });

                    // Sync status updates back to cloud
                    cloudData.requests.forEach(cr => {
                        const local = state.requests.find(lr => lr.id === cr.id);
                        if (local && local.status !== cr.status) cr.status = local.status;
                    });

                    await fetch(`${API_BASE}${state.syncId}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            requests: cloudData.requests,
                            vouchers: cloudData.vouchers,
                            lastUpdated: Date.now()
                        })
                    });
                } else {
                    const res = await fetch(`${API_BASE}${state.syncId}`);
                    if (res.ok) {
                        const data = await res.json();
                        state.requests = data.requests || [];
                        state.vouchers = data.vouchers || [];
                        if (state.isAdmin) renderAdmin();
                    }
                }
            } catch (err) {
                console.warn("Sync Interrupted. retrying in background...", err);
            } finally {
                state.isSyncing = false;
                if (spinner) spinner.classList.add('hidden');
                if (syncDot) syncDot.classList.remove('sync-active');
            }
        }

        // Fast interval for Admin (5s), slow for Portal (30s)
        setInterval(() => {
            if (state.isAdmin) syncData('pull');
        }, 5000); 

        // --- PORTAL ACTIONS ---
        window.switchTab = (tab) => {
            state.currentTab = tab;
            document.getElementById('view-portal').classList.toggle('hidden', tab !== 'portal');
            document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('nav-portal').classList.toggle('active-tab', tab === 'portal');
            document.getElementById('nav-admin').classList.toggle('active-tab', tab === 'admin');

            if (tab === 'admin') {
                document.getElementById('admin-sync-id').value = state.syncId === 'MTAANI-DEFAULT' ? '' : state.syncId;
                renderAdmin();
            }
        };

        window.openPayModal = (name, price) => {
            state.selectedPlan = { name, price };
            document.getElementById('pay-amount').innerText = price.toLocaleString();
            document.getElementById('modal-pay').classList.remove('hidden');
        };

        window.closePayModal = () => {
            document.getElementById('modal-pay').classList.add('hidden');
        };

        window.submitRequest = async () => {
            const name = document.getElementById('user-name').value;
            const phone = document.getElementById('user-phone').value;
            const btn = document.getElementById('btn-submit-req');
            
            if(!name || !phone) return alert("Tafadhali jaza Jina na Namba ya Simu!");

            btn.innerText = "INAUNGANISHA KWENYE CLOUD...";
            btn.disabled = true;

            const newReq = {
                id: Date.now() + Math.random(), // High entropy ID
                name,
                phone,
                plan: state.selectedPlan.name,
                price: state.selectedPlan.price,
                status: 'pending',
                date: new Date().toLocaleString('sw-TZ'),
                deviceId: navigator.userAgent.substring(0, 20)
            };

            // Push request to global cloud
            state.requests.unshift(newReq);
            await syncData('push');

            // Optional SMS fallback
            const body = `MTAANI WIFI: Nahitaji vocha ya ${state.selectedPlan.name}. Jina: ${name}, Namba: ${phone}. ID: ${state.syncId}`;
            window.location.href = `sms:0779231924?body=${encodeURIComponent(body)}`;

            alert("OMBI LIMEPOKELEWA! James na wateja wengine sasa wanaonekana kwenye Admin Portal ya kifaa chochote.");
            btn.innerText = "TUMA OMBI LA VOCHA";
            btn.disabled = false;
            closePayModal();
        };

        // --- ADMIN PORTAL ---
        window.loginAdmin = async () => {
            const pass = document.getElementById('admin-pass').value;
            const sid = document.getElementById('admin-sync-id').value.toUpperCase().trim();
            
            if (!sid) return alert("Tafadhali weka Business Sync ID yako!");
            if (pass === 'mtaani') {
                state.syncId = sid;
                localStorage.setItem('last_sync_id', sid);
                document.getElementById('header-sync-id').innerText = `ID: ${sid}`;
                state.isAdmin = true;
                sessionStorage.setItem('admin_logged', 'true');
                
                await syncData('pull'); 
                renderAdmin();
            } else {
                alert("Password sio sahihi!");
            }
        };

        window.logoutAdmin = () => {
            state.isAdmin = false;
            sessionStorage.removeItem('admin_logged');
            renderAdmin();
        };

        const renderAdmin = () => {
            const authDiv = document.getElementById('admin-lock');
            const dashboardDiv = document.getElementById('admin-content');
            
            if (!state.isAdmin) {
                authDiv.classList.remove('hidden');
                dashboardDiv.classList.add('hidden');
                return;
            }

            authDiv.classList.add('hidden');
            dashboardDiv.classList.remove('hidden');
            
            document.getElementById('display-sync-id').innerText = state.syncId;

            const revenue = state.requests.filter(r => r.status === 'approved').reduce((a, b) => a + b.price, 0);
            const pending = state.requests.filter(r => r.status === 'pending').length;

            document.getElementById('stat-revenue').innerText = `Tsh ${revenue.toLocaleString()}`;
            document.getElementById('stat-pending').innerText = pending;

            const list = document.getElementById('request-list');
            if (state.requests.length === 0) {
                list.innerHTML = '<tr><td colspan="3" class="p-20 text-center opacity-30 uppercase font-black tracking-widest text-[10px]">Hakuna maombi kwenye Cloud kwa sasa</td></tr>';
            } else {
                list.innerHTML = '';
                state.requests.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-[#44403c]/10 transition-colors border-b border-[#44403c]/10 group";
                    tr.innerHTML = `
                        <td class="px-10 py-8">
                            <div class="font-black uppercase text-sm tracking-tight text-white">${r.name}</div>
                            <div class="text-[10px] text-[#78350f] font-mono mt-1 font-bold">${r.phone}</div>
                            <div class="text-[8px] text-[#44403c] mt-2 font-black uppercase tracking-widest">${r.date}</div>
                        </td>
                        <td class="px-10 py-8">
                            <div class="font-black uppercase text-xs tracking-wider text-white">${r.plan}</div>
                            <div class="text-[10px] text-[#78350f] font-bold">Tsh ${r.price.toLocaleString()}</div>
                        </td>
                        <td class="px-10 py-8 text-center">
                            ${r.status === 'pending' ? 
                                `<button onclick="approveRequest(${r.id})" class="p-4 bg-green-500/10 text-green-500 rounded-2xl hover:bg-green-500 hover:text-white transition-all border border-green-500/20 shadow-xl group-hover:scale-110"><i data-lucide="check" class="w-6 h-6"></i></button>` : 
                                `<div class="flex flex-col items-center">
                                    <span class="px-4 py-2 bg-white/5 rounded-full text-[9px] font-black uppercase opacity-40 border border-white/10 tracking-widest">Approved</span>
                                    <span class="text-[8px] font-mono mt-2 text-[#78350f]">${r.voucher || ''}</span>
                                </div>`
                            }
                        </td>
                    `;
                    list.appendChild(tr);
                });
            }

            lucide.createIcons();
            runAIInsight();
        };

        window.approveRequest = async (id) => {
            const req = state.requests.find(r => r.id === id);
            if (!req) return;

            const code = "MT-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            req.status = 'approved';
            req.voucher = code;
            
            // Push update to cloud immediately
            await syncData('push');

            alert(`IMEIDHINISHWA! Mteja James sasa anaweza kuona code yake kwenye simu yake. Code ni: ${code}`);
            
            // SMS prompt
            const body = `MTAANI WIFI: Vocha yako ya ${req.plan} ni ${code}. Furahia Internet!`;
            window.location.href = `sms:${req.phone}?body=${encodeURIComponent(body)}`;

            renderAdmin();
        };

        // --- UTILS ---
        window.copyCustomerLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?sid=${state.syncId}`;
            navigator.clipboard.writeText(url).then(() => {
                alert("Link ya wateja imenakiliwa! Wateja wakitumia link hii, utawaona kwenye Dashboard yako popote ulipo.");
            });
        };

        const runAIInsight = async () => {
            try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                const reqCount = state.requests.length;
                const rev = state.requests.filter(r => r.status === 'approved').reduce((a, b) => a + b.price, 0);

                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `Kama meneja wa biashara ya Internet, toa tathmini fupi sana (sentensi 1) ya biashara yenye maombi ${reqCount} na mapato ya Tsh ${rev}. Tumia lugha ya mtaani inayovutia na eleza kwamba kila kitu kipo 'Cloud Synced'.`,
                });
                
                document.getElementById('ai-insight').innerText = response.text || "Cloud Connection Safe. Business is Booming!";
            } catch (e) {
                document.getElementById('ai-insight').innerText = "SYSTEM: ALL NODES SYNCED WORLDWIDE.";
            }
        };

        window.simulateConnect = () => {
            const val = document.getElementById('voucher-input').value;
            if(!val) return alert("Tafadhali weka Code kwanza!");
            const btn = document.getElementById('btn-connect');
            btn.innerText = "INAUNGANISHA KWENYE CLOUD HUB...";
            setTimeout(() => {
                alert("IMEUNGANISHWA! Sasa uko hewani kupitia Mtaani Cloud Wifi.");
                btn.innerText = "UNGANISHA INTERNET";
            }, 1500);
        };

        window.copyScript = () => {
            alert("Script ya MikroTik imenakiliwa!");
        };

        // INITIAL START
        lucide.createIcons();
        switchTab('portal');
        syncData('pull'); 
    </script>
</body>
</html>