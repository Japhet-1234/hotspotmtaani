<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTAANI WIFI | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; overflow-x: hidden; }
        .mtaani-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; font-weight: 700; color: #64748b; transition: all 0.2s; cursor: pointer; }
        .sidebar-link:hover { background: #f1f5f9; color: #2563eb; }
        .sidebar-link.active { background: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2); }
        .hidden { display: none; }
        .code-block { background: #0f172a; color: #38bdf8; padding: 20px; border-radius: 12px; font-family: monospace; font-size: 13px; position: relative; overflow-x: auto; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #toast-sms { transition: all 0.5s ease; transform: translateY(100px); opacity: 0; }
        #toast-sms.show { transform: translateY(0); opacity: 1; }
        
        .notification-dot { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: #ef4444; border: 2px solid white; border-radius: full; }
        .connected-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="sync-bar" class="fixed top-0 left-0 h-1 bg-blue-600 z-[200] transition-all duration-500" style="width: 0%"></div>

    <!-- NOTIFICATION SYSTEM -->
    <div id="toast-sms" class="fixed bottom-8 right-8 z-[1000] bg-slate-900 text-white p-6 rounded-3xl shadow-2xl flex items-center gap-4 border border-white/10">
        <div class="bg-blue-500 p-3 rounded-2xl shadow-lg">
            <i data-lucide="message-circle" class="w-6 h-6 text-white"></i>
        </div>
        <div>
            <p class="text-[10px] font-black uppercase tracking-widest text-blue-400">Alert</p>
            <p id="sms-msg" class="text-sm font-bold">Imekamilika!</p>
        </div>
    </div>

    <div class="flex flex-1 h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside id="admin-sidebar" class="hidden w-72 bg-white border-r border-slate-200 flex flex-col p-6 animate-in slide-in-from-left duration-500">
            <div class="flex items-center gap-3 mb-10 px-2">
                <div class="bg-slate-900 p-2 rounded-2xl"><i data-lucide="wifi" class="text-white w-5 h-5"></i></div>
                <h2 class="font-black text-xl tracking-tight uppercase">JEFF <span class="text-blue-600">HUB</span></h2>
            </div>
            
            <nav class="flex-1 space-y-1">
                <div onclick="setAdminTab('dash')" id="tab-dash" class="sidebar-link active"><i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard</div>
                <div onclick="setAdminTab('users')" id="tab-users" class="sidebar-link"><i data-lucide="users" class="w-5 h-5"></i> Wateja & Sessions</div>
                <div onclick="setAdminTab('routers')" id="tab-routers" class="sidebar-link"><i data-lucide="router" class="w-5 h-5"></i> Router Info</div>
                <div onclick="setAdminTab('messages')" id="tab-messages" class="sidebar-link relative"><i data-lucide="mail" class="w-5 h-5"></i> Ujumbe (Inbox) <span id="msg-badge" class="hidden notification-dot"></span></div>
                <div onclick="setAdminTab('config')" id="tab-config" class="sidebar-link"><i data-lucide="terminal" class="w-5 h-5"></i> Config Codes</div>
                <div onclick="setAdminTab('logs')" id="tab-logs" class="sidebar-link"><i data-lucide="history" class="w-5 h-5"></i> System Logs</div>
            </nav>

            <div class="mt-auto pt-6 border-t border-slate-100">
                <button onclick="doLogout()" class="sidebar-link text-red-500 hover:bg-red-50 w-full"><i data-lucide="power" class="w-5 h-5"></i> Logout</button>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <div class="flex-1 flex flex-col overflow-y-auto custom-scroll">
            <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 px-8 py-5 flex items-center justify-between">
                <div>
                    <h1 id="view-title" class="text-sm font-black uppercase tracking-widest text-slate-400">Portal ya Mteja</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="admin-entry-btn" onclick="switchView('admin')" class="bg-slate-100 text-slate-600 px-5 py-2 rounded-xl text-xs font-black uppercase">Admin Portal</button>
                    <button id="client-entry-btn" onclick="switchView('portal')" class="hidden bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-black uppercase">Rudi Portal</button>
                </div>
            </header>

            <main class="p-8">
                
                <!-- CLIENT PORTAL -->
                <div id="view-portal" class="max-w-4xl mx-auto space-y-10">
                    
                    <!-- STATUS BADGE (Kama ameshaunganishwa) -->
                    <div id="status-active" class="hidden bg-emerald-50 border-2 border-emerald-100 p-6 rounded-3xl flex items-center justify-between animate-in slide-in-from-top">
                        <div class="flex items-center gap-4">
                            <div class="bg-emerald-500 p-3 rounded-2xl text-white connected-badge"><i data-lucide="wifi"></i></div>
                            <div>
                                <p class="text-xs font-black text-emerald-600 uppercase tracking-widest">Hali: UMEUNGANISHWA</p>
                                <h3 id="timer-display" class="text-2xl font-black text-slate-900">Masaa 24:00:00</h3>
                            </div>
                        </div>
                        <button onclick="disconnectManually()" class="bg-slate-200 text-slate-600 px-6 py-3 rounded-2xl text-xs font-black uppercase">Disconnect</button>
                    </div>

                    <div class="bg-blue-600 rounded-[3rem] p-12 text-white relative overflow-hidden shadow-2xl">
                        <div class="relative z-10 space-y-6">
                            <span class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Jeff Mtaani Hotspot</span>
                            <h2 class="text-5xl font-black tracking-tighter">WiFi Unlimited. <br>Buku Tu Siku Nzima.</h2>
                            <div class="flex gap-4">
                                <button onclick="openPayment('MTAA-UNLIMITED-24H', 1000)" class="bg-white text-blue-600 px-8 py-4 rounded-2xl font-black uppercase text-xs shadow-lg">Lipa 1,000 (Siku 1)</button>
                                <button onclick="openSupport()" class="bg-blue-500/50 text-white px-8 py-4 rounded-2xl font-black uppercase text-xs backdrop-blur-md">Msaada / Chat</button>
                            </div>
                        </div>
                        <i data-lucide="zap" class="absolute -right-10 -bottom-10 w-64 h-64 text-white opacity-10"></i>
                    </div>

                    <div id="voucher-form" class="mtaani-card p-10 space-y-6">
                        <h3 class="text-xl font-black uppercase tracking-tight">Ingiza Vocha Hapa</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input id="v-input" type="text" placeholder="VOCHA-XXXXX" class="flex-1 bg-slate-50 border-2 border-slate-100 p-6 rounded-2xl text-center text-3xl font-black uppercase tracking-widest outline-none focus:border-blue-600">
                            <button onclick="connectNow()" class="bg-slate-900 text-white px-10 py-6 rounded-2xl font-black text-lg">UNGANISHA</button>
                        </div>
                    </div>
                </div>

                <!-- ADMIN CENTER -->
                <div id="view-admin" class="hidden">
                    <div id="admin-lock" class="max-w-md mx-auto mtaani-card p-12 space-y-6 mt-10">
                        <h2 class="text-center text-2xl font-black">Jeff Login</h2>
                        <input id="adm-user" type="text" placeholder="Username" class="w-full p-4 border rounded-xl font-bold">
                        <input id="adm-pass" type="password" placeholder="Password" class="w-full p-4 border rounded-xl font-bold">
                        <button onclick="doLogin()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-black uppercase">Fungua</button>
                    </div>

                    <div id="admin-main" class="hidden space-y-8">
                        
                        <!-- TAB: DASHBOARD -->
                        <div id="sec-dash" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div class="mtaani-card p-8 bg-blue-600 text-white border-none shadow-xl"><p class="text-[10px] font-black uppercase text-blue-200">Revenue</p><h3 id="stat-rev" class="text-3xl font-black">Tsh 0</h3></div>
                                <div class="mtaani-card p-8"><p class="text-[10px] font-black uppercase text-slate-400">Pending</p><h3 id="stat-pending" class="text-3xl font-black text-blue-600">0</h3></div>
                                <div class="mtaani-card p-8"><p class="text-[10px] font-black uppercase text-slate-400">Inbox</p><h3 id="stat-msg" class="text-3xl font-black text-orange-500">0</h3></div>
                                <div class="mtaani-card p-8"><p class="text-[10px] font-black uppercase text-slate-400">Online Sasa</p><h3 id="stat-active" class="text-3xl font-black text-emerald-500">0</h3></div>
                            </div>
                            
                            <div class="mtaani-card overflow-hidden">
                                <div class="p-6 border-b font-black uppercase text-xs tracking-widest text-slate-400">Maombi ya Vocha (Sasa Hivi)</div>
                                <div class="overflow-x-auto"><table class="w-full text-left"><tbody id="adm-orders"></tbody></table></div>
                            </div>
                        </div>

                        <!-- TAB: WATEJA & SESSIONS -->
                        <div id="sec-users" class="hidden space-y-6">
                            <h3 class="text-2xl font-black">Wateja na Session Zinazoendelea</h3>
                            <div id="user-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>

                        <!-- TAB: MESSAGES -->
                        <div id="sec-messages" class="hidden space-y-6">
                            <h3 class="text-2xl font-black">Inbox - Ujumbe kutoka kwa Wateja</h3>
                            <div class="mtaani-card overflow-hidden">
                                <div class="divide-y divide-slate-100" id="inbox-list"></div>
                            </div>
                        </div>

                        <!-- TAB: ROUTERS -->
                        <div id="sec-routers" class="hidden space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="mtaani-card p-8 h-fit">
                                    <h4 class="font-black mb-4">Sajili Router Mpya</h4>
                                    <input id="r-name" type="text" placeholder="Jina la Router" class="w-full p-4 border rounded-xl mb-4 font-bold">
                                    <input id="r-ip" type="text" placeholder="IP Address" class="w-full p-4 border rounded-xl mb-4 font-mono">
                                    <button onclick="addRouter()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-black uppercase text-xs">Sajili Sasa</button>
                                </div>
                                <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4" id="router-list"></div>
                            </div>
                        </div>

                        <!-- TAB: CONFIG -->
                        <div id="sec-config" class="hidden space-y-6">
                            <div class="mtaani-card p-10 space-y-8">
                                <h3 class="text-2xl font-black">Router Configuration Codes</h3>
                                <div class="space-y-4">
                                    <p class="text-xs font-black text-slate-400 uppercase">Step 1: Setup Basic Hotspot</p>
                                    <div class="code-block">/ip hotspot profile add name=MtaaniProfile login-by=http-chap<br>/ip hotspot add interface=bridge1 profile=MtaaniProfile</div>
                                    <p class="text-xs font-black text-slate-400 uppercase">Step 2: Walled Garden Rules</p>
                                    <div class="code-block">/ip hotspot walled-garden add dst-host=kvdb.io<br>/ip hotspot walled-garden add dst-host=google.com</div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: LOGS -->
                        <div id="sec-logs" class="hidden space-y-6">
                            <div class="mtaani-card p-8 font-mono text-xs h-[600px] overflow-y-auto custom-scroll space-y-2 bg-slate-50" id="log-container"></div>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="modal-pay" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-sm">
        <div class="w-full max-w-lg mtaani-card p-10 space-y-6 animate-in zoom-in duration-300">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-black">Kifurushi Unlimited</h3>
                <button onclick="closePayment()" class="text-slate-400"><i data-lucide="x"></i></button>
            </div>
            <div class="bg-blue-600 p-8 rounded-3xl text-white text-center">
                <p class="text-[10px] font-black uppercase mb-2">Lipa Kiasi cha:</p>
                <div id="pay-amount" class="text-4xl font-black">Tsh 1,000</div>
                <div class="mt-4 text-xs font-mono bg-white/10 p-2 rounded-lg">Masaa 24 Unlimited WiFi</div>
            </div>
            <div class="space-y-4">
                <p class="text-sm font-bold text-slate-500">Jaza maelezo yako kwanza kisha utatuma ujumbe direct kwa Jeff.</p>
                <input id="p-name" type="text" placeholder="Jina lako" class="w-full p-4 border rounded-xl font-bold focus:border-blue-600 outline-none">
                <input id="p-phone" type="tel" placeholder="Namba yako ya Malipo" class="w-full p-4 border rounded-xl font-black focus:border-blue-600 outline-none">
                <button onclick="sendOrder()" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-xl flex items-center justify-center gap-3">TUMA OMBI & SMS <i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <!-- SUPPORT MODAL -->
    <div id="modal-support" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-sm">
        <div class="w-full max-w-md mtaani-card p-10 space-y-6">
            <h3 class="text-2xl font-black">Ujumbe kwa Jeff</h3>
            <p class="text-slate-500 text-sm">Andika shida yako hapa, Jeff atakujibu haraka.</p>
            <input id="s-phone" type="tel" placeholder="Namba yako ya Simu" class="w-full p-4 border rounded-xl font-black">
            <textarea id="s-msg" placeholder="Andika ujumbe wako..." class="w-full p-4 border rounded-xl font-medium h-32 resize-none"></textarea>
            <button onclick="sendSupportMsg()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black uppercase">TUMA UJUMBE</button>
            <button onclick="closeSupport()" class="w-full text-slate-400 text-xs font-bold uppercase">Funga</button>
        </div>
    </div>

    <script type="module">
        const JEFF_PHONE = "0779231924";
        const BUCKET = 'mtaani_pro_v8_session_sync';
        const CLOUD_API = `https://kvdb.io/K9pS6YJ7T3xY2ZqG1A5u5G/${BUCKET}`;
        const EXPIRY_HOURS = 24;

        let state = {
            orders: [],
            nodes: [],
            routers: [],
            messages: [],
            logs: [],
            activeSessions: [], // Track current active users and expiry
            isAdmin: sessionStorage.getItem('mtaani_auth') === 'true',
            myId: getLocalId()
        };

        function getLocalId() {
            let id = localStorage.getItem('mtaani_node_id');
            if(!id) {
                id = 'MTAA-' + Math.floor(1000 + Math.random() * 8999);
                localStorage.setItem('mtaani_node_id', id);
            }
            return id;
        }

        function save() { localStorage.setItem('mtaani_local_db', JSON.stringify(state)); }

        async function syncPush() {
            save();
            try { await fetch(CLOUD_API, { method: 'POST', body: JSON.stringify(state) }); } 
            catch(e) { console.warn("Sync Offline."); }
        }

        async function syncPull() {
            try {
                const res = await fetch(CLOUD_API);
                if(res.ok) {
                    const data = await res.json();
                    state = { ...state, ...data };
                    checkMySession();
                    render();
                }
            } catch(e) {}
        }

        function addLog(m) {
            state.logs.unshift(`[${new Date().toLocaleTimeString()}] ${m}`);
            if(state.logs.length > 100) state.logs.pop();
            save();
        }

        // TIMER & EXPIRY LOGIC
        function checkMySession() {
            const mySess = state.activeSessions.find(s => s.nodeId === state.myId);
            const statusDiv = document.getElementById('status-active');
            const vForm = document.getElementById('voucher-form');

            if(mySess) {
                const remaining = mySess.expiry - Date.now();
                if(remaining <= 0) {
                    // EXPIRED!
                    state.activeSessions = state.activeSessions.filter(s => s.nodeId !== state.myId);
                    syncPush();
                    alert("Kifurushi chako cha masaa 24 kimeisha. Tafadhali lipia tena!");
                    statusDiv.classList.add('hidden');
                    vForm.classList.remove('hidden');
                } else {
                    statusDiv.classList.remove('hidden');
                    vForm.classList.add('hidden');
                    updateTimerDisplay(remaining);
                }
            } else {
                statusDiv.classList.add('hidden');
                vForm.classList.remove('hidden');
            }
        }

        function updateTimerDisplay(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((ms % (1000 * 60)) / 1000);
            document.getElementById('timer-display').innerText = 
                `Masaa ${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        window.connectNow = async () => {
            const v = document.getElementById('v-input').value.trim();
            if(!v) return alert("Weka vocha kwanza!");

            // Find order with this voucher
            const order = state.orders.find(o => o.voucher === v);
            
            if(!order) {
                alert("Vocha hii haipo. Hakikisha umeingiza namba sahihi!");
                return;
            }

            if(order.status !== 'approved') {
                alert("Vocha hii bado haijatolewa. Subiri kidogo au wasiliana na Jeff.");
                return;
            }

            // Check if already used by someone else OR already expired
            const existingSess = state.activeSessions.find(s => s.voucher === v);
            if(existingSess && existingSess.nodeId !== state.myId) {
                alert("Vocha hii inatumiwa na kifaa kingine!");
                return;
            }

            // Create new session
            const startTime = Date.now();
            const expiry = startTime + (EXPIRY_HOURS * 60 * 60 * 1000);
            
            state.activeSessions.push({
                nodeId: state.myId,
                voucher: v,
                name: order.name,
                startTime: startTime,
                expiry: expiry
            });

            addLog(`Mteja ${order.name} ameunganishwa na Vocha ${v}`);
            await syncPush();
            checkMySession();
            notify("Umeunganishwa kikamilifu!");
        };

        window.disconnectManually = () => {
            if(confirm("Je, unataka kujitoa kwenye WiFi?")) {
                state.activeSessions = state.activeSessions.filter(s => s.nodeId !== state.myId);
                syncPush();
                checkMySession();
            }
        };

        // ADMIN RENDER
        function render() {
            if(state.isAdmin) renderAdmin();
            lucide.createIcons();
        }

        function renderAdmin() {
            document.getElementById('stat-rev').innerText = `Tsh ${state.orders.filter(o => o.status === 'approved').reduce((a, b) => a + b.price, 0).toLocaleString()}`;
            document.getElementById('stat-pending').innerText = state.orders.filter(o => o.status === 'pending').length;
            document.getElementById('stat-msg').innerText = state.messages.filter(m => !m.read).length;
            document.getElementById('stat-active').innerText = state.activeSessions.length;

            const msgBadge = document.getElementById('msg-badge');
            if(state.messages.some(m => !m.read)) msgBadge.classList.remove('hidden');
            else msgBadge.classList.add('hidden');

            const ol = document.getElementById('adm-orders');
            ol.innerHTML = state.orders.map(o => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-8 py-5">
                        <div class="font-black">${o.name}</div>
                        <div class="text-[10px] text-slate-400 font-mono">${o.node}</div>
                    </td>
                    <td class="px-8 py-5"><div class="font-black text-sm">${o.phone}</div></td>
                    <td class="px-8 py-5"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase">${o.plan}</span></td>
                    <td class="px-8 py-5 text-right">
                        ${o.status === 'pending' ? 
                            `<button onclick="approveOrder(${o.id})" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Approve</button>` : 
                            `<div class="flex items-center gap-3 justify-end">
                                <span class="text-emerald-600 font-black text-xs">Vocha: ${o.voucher}</span>
                                <button onclick="sendVoucherSMS('${o.phone}', '${o.voucher}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><i data-lucide="send" class="w-4 h-4"></i></button>
                             </div>`
                        }
                    </td>
                </tr>
            `).join('');

            const uc = document.getElementById('user-cards');
            uc.innerHTML = state.nodes.map(n => {
                const active = state.activeSessions.find(s => s.nodeId === n.id);
                return `
                <div class="mtaani-card p-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div class="p-3 ${active ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-50 text-blue-600'} rounded-2xl"><i data-lucide="user"></i></div>
                        <div class="text-[9px] font-black uppercase ${active ? 'text-emerald-500' : 'text-slate-300'}">${active ? 'Connected' : 'Offline'}</div>
                    </div>
                    <div>
                        <h4 class="font-black text-lg">${active ? active.name : (n.name || 'Anonymous')}</h4>
                        <p class="text-[10px] font-mono text-slate-400">${n.id}</p>
                        ${active ? `<p class="text-[10px] font-black text-emerald-600 uppercase mt-1">Expiry: ${new Date(active.expiry).toLocaleTimeString()}</p>` : ''}
                    </div>
                    <div class="pt-4 border-t flex justify-between items-center">
                        <span class="text-[9px] font-black uppercase text-slate-400">${n.device}</span>
                        <div class="flex gap-2">
                             <button onclick="window.location.href='tel:${n.phone}'" class="text-blue-600"><i data-lucide="phone" class="w-4 h-4"></i></button>
                             ${active ? `<button onclick="terminateSession('${n.id}')" class="text-red-500" title="Disconnect"><i data-lucide="zap-off" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

            const il = document.getElementById('inbox-list');
            il.innerHTML = state.messages.map(m => `
                <div class="p-6 hover:bg-slate-50 flex justify-between items-start group">
                    <div class="space-y-1">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-slate-900">${m.phone}</span>
                            ${!m.read ? '<span class="w-2 h-2 bg-blue-600 rounded-full"></span>' : ''}
                        </div>
                        <p class="text-sm text-slate-600 font-medium">${m.body}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase">${m.time}</p>
                    </div>
                    <button onclick="markRead(${m.id})" class="opacity-0 group-hover:opacity-100 p-2 bg-white border rounded-xl text-xs font-bold text-slate-400">Mark Read</button>
                </div>
            `).join('');

            const rl = document.getElementById('router-list');
            rl.innerHTML = state.routers.map(r => `<div class="mtaani-card p-6 border-2 border-slate-100"><i data-lucide="router" class="text-blue-600 mb-4"></i><h5 class="font-black">${r.name}</h5><p class="text-xs font-mono text-slate-400">${r.ip}</p></div>`).join('');
            const lc = document.getElementById('log-container');
            lc.innerHTML = state.logs.map(l => `<div class="py-1 border-b">${l}</div>`).join('');
        }

        window.terminateSession = async (nodeId) => {
            if(confirm("Unataka kumtoa huyu mteja?")) {
                state.activeSessions = state.activeSessions.filter(s => s.nodeId !== nodeId);
                addLog(`Admin amemtoa mteja ${nodeId}`);
                await syncPush();
                renderAdmin();
            }
        };

        window.approveOrder = async (id) => {
            const idx = state.orders.findIndex(o => o.id === id);
            if(idx !== -1) {
                const voucher = 'V-' + Math.floor(10000 + Math.random() * 89999);
                state.orders[idx].status = 'approved';
                state.orders[idx].voucher = voucher;
                addLog(`Vocha Mpya: ${voucher} kwenda ${state.orders[idx].name}`);
                await syncPush();
                notify(`Voucher ${voucher} tayari!`);
                renderAdmin();
            }
        };

        window.sendVoucherSMS = (phone, voucher) => {
            const msg = `MTAANI WIFI: Habari, vocha yako ni ${voucher}. Ingiza kwenye portal sasa. Karibu tena!`;
            window.location.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
        };

        window.switchView = (v) => {
            document.getElementById('view-portal').classList.toggle('hidden', v !== 'portal');
            document.getElementById('view-admin').classList.toggle('hidden', v !== 'admin');
            document.getElementById('admin-sidebar').classList.toggle('hidden', v !== 'admin' || !state.isAdmin);
            document.getElementById('admin-entry-btn').classList.toggle('hidden', v === 'admin');
            document.getElementById('client-entry-btn').classList.toggle('hidden', v !== 'admin');
            if(v === 'admin' && state.isAdmin) setAdminTab('dash');
            syncPull();
        };

        window.setAdminTab = (t) => {
            ['dash', 'users', 'messages', 'routers', 'config', 'logs'].forEach(tab => {
                document.getElementById(`sec-${tab}`).classList.toggle('hidden', tab !== t);
                document.getElementById(`tab-${tab}`).classList.toggle('active', tab === t);
            });
            lucide.createIcons();
        };

        window.openPayment = (plan, price) => {
            state.currentPlan = { plan, price };
            document.getElementById('modal-pay').classList.remove('hidden');
        };
        window.closePayment = () => document.getElementById('modal-pay').classList.add('hidden');

        window.sendOrder = async () => {
            const name = document.getElementById('p-name').value;
            const phone = document.getElementById('p-phone').value;
            if(!name || !phone) return alert("Jaza jina na namba kwanza!");
            const order = { id: Date.now(), node: state.myId, name, phone, plan: state.currentPlan.plan, price: state.currentPlan.price, status: 'pending', voucher: null };
            state.orders.unshift(order);
            await syncPush();
            const message = `Habari Jeff, nimepata malipo ya Tsh 1,000. Jina: ${name}, Namba: ${phone}. Naomba vocha.`;
            window.location.href = `sms:${JEFF_PHONE}?body=${encodeURIComponent(message)}`;
            closePayment();
        };

        window.doLogin = () => {
            const u = document.getElementById('adm-user').value.trim();
            const p = document.getElementById('adm-pass').value;
            if(u === 'jeff' && p === 'mtaani') {
                state.isAdmin = true;
                sessionStorage.setItem('mtaani_auth', 'true');
                document.getElementById('admin-lock').classList.add('hidden');
                document.getElementById('admin-main').classList.remove('hidden');
                document.getElementById('admin-sidebar').classList.remove('hidden');
                renderAdmin();
            } else alert("Login Failed!");
        };

        window.doLogout = () => { sessionStorage.clear(); location.reload(); };

        function notify(m) {
            const t = document.getElementById('toast-sms');
            document.getElementById('sms-msg').innerText = m;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 5000);
        }

        async function track() {
            if(state.isAdmin) return;
            const now = Date.now();
            const dev = navigator.userAgent.includes("Mobile") ? "Simu" : "PC";
            const idx = state.nodes.findIndex(n => n.id === state.myId);
            if(idx === -1) { state.nodes.unshift({ id: state.myId, last: now, device: dev, phone: '' }); await syncPush(); }
            else { state.nodes[idx].last = now; if(now % 10 === 0) await syncPush(); }
        }

        // STARTUP
        const localData = localStorage.getItem('mtaani_local_db');
        if(localData) state = JSON.parse(localData);
        if(state.isAdmin) switchView('admin');

        syncPull();
        setInterval(syncPull, 10000);
        setInterval(track, 15000);
        setInterval(checkMySession, 1000); // UI Timer Update
        lucide.createIcons();
    </script>
</body>
</html>