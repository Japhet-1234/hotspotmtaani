<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEFF WIFI MASTER | Admin Core v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; }
        .glass-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .btn-blue { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; transition: all 0.3s; }
        .btn-blue:hover { transform: translateY(-2px); shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4); }
        .nav-link { font-weight: 700; color: #64748b; padding: 8px 16px; border-radius: 12px; transition: all 0.3s; }
        .nav-link.active { background-color: #2563eb; color: white; }
        .hidden { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .pulse-green { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        #toast-sms { transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateX(400px); opacity: 0; }
        #toast-sms.show { transform: translateX(0); opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- SYNC LOADER -->
    <div id="sync-progress" class="fixed top-0 left-0 h-1.5 bg-blue-600 z-[200] transition-all duration-700" style="width: 0%"></div>

    <!-- GLOBAL SMS ALERT -->
    <div id="toast-sms" class="fixed top-24 right-6 z-[1000] bg-slate-900 text-white px-8 py-6 rounded-[2rem] shadow-2xl flex items-center gap-5 border border-white/10">
        <div class="bg-emerald-500 p-3 rounded-2xl">
            <i data-lucide="message-square" class="w-6 h-6 text-white"></i>
        </div>
        <div>
            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-400">System Notification</p>
            <p id="sms-msg" class="text-sm font-bold mt-1">SMS imetumwa kwa mteja!</p>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl shadow-xl shadow-blue-100 rotate-3">
                    <i data-lucide="zap" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-slate-900">JEFF <span class="text-blue-600">CORE v5</span></h1>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Active Master Node</p>
                    </div>
                </div>
            </div>
            
            <nav class="hidden md:flex bg-slate-100 p-1.5 rounded-2xl gap-2">
                <button onclick="switchView('portal')" id="nav-portal" class="nav-link active">Customer Portal</button>
                <button onclick="switchView('admin')" id="nav-admin" class="nav-link">Admin Core</button>
            </nav>

            <div class="flex items-center gap-3">
                <div class="hidden sm:block text-right">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Server Region</p>
                    <p class="text-xs font-black text-slate-900 uppercase">East Africa</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center">
                    <i data-lucide="globe" class="w-5 h-5 text-slate-400"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-6 md:p-10">
        
        <!-- CUSTOMER VIEW -->
        <div id="view-portal" class="space-y-10 animate-in fade-in duration-500">
            <!-- Hero -->
            <div class="bg-slate-900 rounded-[3rem] p-10 md:p-24 text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10 space-y-8 max-w-2xl">
                    <span class="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-full uppercase tracking-widest">Welcome to Jeff WiFi</span>
                    <h2 class="text-5xl md:text-7xl font-black leading-none tracking-tighter">Unlimited Internet <br> <span class="text-blue-500">Kila Kona.</span></h2>
                    <p class="text-slate-400 text-lg md:text-xl font-medium max-w-md">Chagua kifurushi chako, thibitisha malipo, na upate vocha yako kwa SMS papo hapo.</p>
                </div>
                <div class="absolute right-0 bottom-0 opacity-10 p-10">
                    <i data-lucide="wifi" class="w-96 h-96"></i>
                </div>
            </div>

            <!-- Packages -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="glass-card p-10 hover:shadow-2xl transition-all group">
                    <div class="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center mb-8 group-hover:bg-blue-600 group-hover:text-white transition-all">
                        <i data-lucide="clock" class="w-7 h-7"></i>
                    </div>
                    <h4 class="text-3xl font-black text-slate-900">Saa 6</h4>
                    <p class="text-slate-400 mt-2 font-medium">Bando ya haraka.</p>
                    <div class="mt-8 pt-8 border-t border-slate-100 flex items-end justify-between">
                        <div class="text-3xl font-black text-slate-900 leading-none">Tsh 500</div>
                        <button onclick="openPayment('LITE-6H', 500)" class="px-8 py-3 btn-blue rounded-xl font-black text-xs uppercase tracking-widest">Lipia sasa</button>
                    </div>
                </div>
                <div class="glass-card p-10 hover:shadow-2xl transition-all group relative border-2 border-blue-600">
                    <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-1.5 rounded-full text-[10px] font-black uppercase">Most Popular</div>
                    <div class="w-14 h-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center mb-8">
                        <i data-lucide="sun" class="w-7 h-7"></i>
                    </div>
                    <h4 class="text-3xl font-black text-slate-900">Siku 1</h4>
                    <p class="text-slate-400 mt-2 font-medium">Matumizi ya siku nzima.</p>
                    <div class="mt-8 pt-8 border-t border-slate-100 flex items-end justify-between">
                        <div class="text-3xl font-black text-slate-900 leading-none">Tsh 1,000</div>
                        <button onclick="openPayment('PRO-24H', 1000)" class="px-8 py-3 btn-blue rounded-xl font-black text-xs uppercase tracking-widest">Lipia sasa</button>
                    </div>
                </div>
                <div class="glass-card p-10 hover:shadow-2xl transition-all group">
                    <div class="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center mb-8 group-hover:bg-blue-600 group-hover:text-white transition-all">
                        <i data-lucide="calendar" class="w-7 h-7"></i>
                    </div>
                    <h4 class="text-3xl font-black text-slate-900">Wiki 1</h4>
                    <p class="text-slate-400 mt-2 font-medium">Ulipaji wa mara moja.</p>
                    <div class="mt-8 pt-8 border-t border-slate-100 flex items-end justify-between">
                        <div class="text-3xl font-black text-slate-900 leading-none">Tsh 5,000</div>
                        <button onclick="openPayment('MASTER-7D', 5000)" class="px-8 py-3 btn-blue rounded-xl font-black text-xs uppercase tracking-widest">Lipia sasa</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Connection -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-card p-12 space-y-10">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center">
                            <i data-lucide="key" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-2xl font-black">Unganisha Internet</h3>
                    </div>
                    <div class="space-y-6">
                        <input id="v-input" type="text" placeholder="JEFF-XXXXX" class="w-full bg-slate-50 border-2 border-slate-100 rounded-3xl py-8 px-8 text-center text-4xl font-black text-slate-900 focus:border-blue-600 outline-none uppercase tracking-[0.2em] transition-all placeholder:opacity-20">
                        <button onclick="connectNow()" class="w-full py-8 bg-slate-900 text-white rounded-3xl font-black text-xl hover:bg-slate-800 transition-all shadow-2xl">ACTIVE CONNECTION</button>
                    </div>
                </div>
                <div class="glass-card flex flex-col h-[550px]">
                    <div class="p-8 border-b border-slate-50 flex justify-between items-center">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">My Voucher History</h3>
                        <div class="px-3 py-1 bg-slate-100 rounded-full text-[9px] font-black text-slate-500 uppercase" id="node-label">ID: Loading...</div>
                    </div>
                    <div id="cust-history" class="p-4 space-y-4 overflow-y-auto flex-1 custom-scroll">
                        <!-- History loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN CORE VIEW -->
        <div id="view-admin" class="hidden space-y-10 animate-in slide-in-from-bottom duration-500">
            <!-- Login -->
            <div id="admin-lock" class="max-w-md mx-auto glass-card p-12 space-y-10 mt-10">
                <div class="text-center space-y-4">
                    <div class="w-24 h-24 bg-blue-600 text-white rounded-[2.5rem] mx-auto flex items-center justify-center shadow-2xl rotate-6">
                        <i data-lucide="lock" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-3xl font-black tracking-tighter">System Authentication</h2>
                    <p class="text-slate-400 font-medium">Ingiza taarifa za Admin ili kufungua Core Control.</p>
                </div>
                <div class="space-y-4">
                    <input id="adm-user" type="text" placeholder="Username" class="w-full bg-slate-50 border border-slate-200 p-5 rounded-2xl outline-none focus:ring-4 focus:ring-blue-50 font-bold">
                    <input id="adm-pass" type="password" placeholder="Password" class="w-full bg-slate-50 border border-slate-200 p-5 rounded-2xl outline-none focus:ring-4 focus:ring-blue-50 font-bold">
                    <button onclick="doLogin()" class="w-full py-5 btn-blue rounded-2xl font-black uppercase tracking-widest text-sm">Unlock Core</button>
                </div>
            </div>

            <!-- Master Dashboard -->
            <div id="admin-main" class="hidden space-y-10">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="px-4 py-1.5 bg-slate-900 text-white text-[10px] font-black rounded-full uppercase tracking-widest">Root Authority</span>
                            <span id="sync-time" class="text-[10px] font-bold text-slate-400 uppercase">Last Sync: Just now</span>
                        </div>
                        <h2 class="text-5xl font-black text-slate-900 tracking-tighter">Command Center</h2>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="syncPull()" class="p-4 bg-white border border-slate-200 rounded-2xl hover:bg-slate-50">
                            <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i>
                        </button>
                        <button onclick="doLogout()" class="px-8 py-4 bg-red-50 text-red-600 font-black rounded-2xl text-xs uppercase tracking-widest hover:bg-red-100 transition-all">
                            Terminate Session
                        </button>
                    </div>
                </header>

                <!-- Financial Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-8 bg-blue-600 text-white border-none shadow-2xl">
                        <p class="text-[10px] font-black text-blue-200 uppercase tracking-widest mb-4">Gross Revenue</p>
                        <h3 id="stat-rev" class="text-4xl font-black tracking-tighter">Tsh 0</h3>
                        <div class="mt-4 flex items-center gap-2 text-[10px] font-bold text-blue-100">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> +12% vs Yesterday
                        </div>
                    </div>
                    <div class="glass-card p-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Pending Approval</p>
                        <h3 id="stat-pending" class="text-4xl font-black text-blue-600 tracking-tighter">0</h3>
                    </div>
                    <div class="glass-card p-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Active Nodes</p>
                        <h3 id="stat-online" class="text-4xl font-black text-emerald-500 tracking-tighter">0</h3>
                    </div>
                    <div class="glass-card p-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Global Users</p>
                        <h3 id="stat-total" class="text-4xl font-black text-slate-900 tracking-tighter">0</h3>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
                    <!-- Real-time Requests -->
                    <div class="xl:col-span-8 glass-card overflow-hidden flex flex-col min-h-[600px]">
                        <div class="p-8 border-b border-slate-50 bg-slate-50/30 flex justify-between items-center">
                            <h3 class="font-black text-xl">Incoming Orders</h3>
                            <div class="flex gap-2">
                                <span class="w-3 h-3 bg-blue-500 rounded-full animate-ping"></span>
                                <span class="text-[10px] font-black uppercase text-blue-500">Live Stream</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-100">
                                    <tr>
                                        <th class="px-8 py-6">Customer & Node</th>
                                        <th class="px-8 py-6">Plan / Price</th>
                                        <th class="px-8 py-6">Payment Verification</th>
                                        <th class="px-8 py-6 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="adm-orders" class="divide-y divide-slate-50">
                                    <!-- Dynamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- User Database -->
                    <div class="xl:col-span-4 glass-card flex flex-col h-[600px]">
                        <div class="p-8 border-b border-slate-50 bg-slate-50/30">
                            <h3 class="font-black text-xl">User Database</h3>
                        </div>
                        <div id="adm-nodes" class="p-4 space-y-4 overflow-y-auto flex-1 custom-scroll">
                            <!-- Nodes loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CUSTOMER PAYMENT MODAL -->
    <div id="modal-pay" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-xl">
        <div class="w-full max-w-lg glass-card overflow-hidden animate-in zoom-in duration-500 rounded-[3rem]">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-2xl font-black tracking-tight">Thibitisha Muamala</h3>
                <button onclick="closePayment()" class="p-2 hover:bg-slate-200 rounded-full transition-all"><i data-lucide="x"></i></button>
            </div>
            <div class="p-10 space-y-8">
                <div class="bg-blue-600 rounded-[2.5rem] p-10 text-center text-white shadow-2xl relative overflow-hidden">
                    <p class="text-[10px] font-black uppercase tracking-[0.3em] mb-4 text-blue-200">Kiasi cha Kulipa:</p>
                    <div id="pay-amount" class="text-6xl font-black mb-10 tracking-tighter">0</div>
                    <div class="bg-white/10 backdrop-blur-md py-6 px-10 rounded-3xl border border-white/20 inline-block relative z-10">
                        <p class="text-[9px] font-black uppercase text-blue-200 mb-2">Tuma pesa kwenda:</p>
                        <span class="text-3xl font-black font-mono tracking-tighter">0779 231 924</span>
                    </div>
                    <i data-lucide="send" class="absolute -right-10 -bottom-10 w-48 h-48 opacity-10"></i>
                </div>
                
                <div class="space-y-5">
                    <div class="grid grid-cols-1 gap-4">
                        <input id="p-name" type="text" placeholder="Jina lako la utambuzi" class="bg-slate-50 border border-slate-200 p-5 rounded-2xl outline-none focus:border-blue-600 font-bold">
                        <input id="p-phone" type="tel" placeholder="Namba uliyotumia kulipa (Muamala)" class="bg-slate-50 border border-slate-200 p-5 rounded-2xl outline-none focus:border-blue-600 font-black">
                        <input id="p-regname" type="text" placeholder="Jina lilio sajili namba hiyo (M-Pesa/Airtel)" class="bg-slate-50 border border-slate-200 p-5 rounded-2xl outline-none focus:border-blue-600 font-bold">
                    </div>
                    <button onclick="sendOrder()" class="w-full py-6 btn-blue rounded-3xl font-black text-lg shadow-2xl uppercase tracking-widest">TUMA OMBI LA VOCHA</button>
                    <p class="text-center text-[10px] text-slate-400 font-bold uppercase tracking-wider">SMS itatumwa kwa namba ya muamala uliyoingiza hapa.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN MANUAL SMS MODAL -->
    <div id="modal-manual-sms" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-6 bg-slate-900/90 backdrop-blur-xl">
        <div class="w-full max-w-md glass-card p-10 space-y-8">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-black">Send Direct SMS</h3>
                <button onclick="closeManualSMS()"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Receiver Node</p>
                    <p id="manual-node-id" class="text-lg font-black text-blue-600">NODE-XXXX</p>
                </div>
                <input id="manual-phone" type="tel" placeholder="Namba ya simu ya mteja" class="w-full border p-4 rounded-xl outline-none font-bold">
                <textarea id="manual-msg" placeholder="Andika namba ya vocha au ujumbe..." class="w-full border p-4 rounded-xl outline-none font-medium h-32 resize-none"></textarea>
                <button onclick="sendManualSMS()" class="w-full py-4 btn-blue rounded-2xl font-black uppercase tracking-widest">Send SMS Now</button>
            </div>
        </div>
    </div>

    <script type="module">
        // MASTER SERVER ARCHITECTURE
        const CLOUD_MASTER_KEY = 'jeff_master_v5_global_hub';
        const CLOUD_API = `https://kvdb.io/K9pS6YJ7T3xY2ZqG1A5u5G/${CLOUD_MASTER_KEY}`;
        const LOCAL_STORAGE_SERVER = 'jeff_local_storage_server_v5';

        let state = {
            orders: [],
            nodes: [],
            isAdmin: sessionStorage.getItem('jeff_v5_auth') === 'true',
            myNodeId: getMyNodeId(),
            currentPlan: null
        };

        // --- CORE FUNCTIONS ---

        function getMyNodeId() {
            let id = localStorage.getItem('jeff_v5_node_id');
            if(!id) {
                id = 'NODE-' + Math.floor(1000 + Math.random() * 8999);
                localStorage.setItem('jeff_v5_node_id', id);
            }
            return id;
        }

        function loadLocal() {
            const data = localStorage.getItem(LOCAL_STORAGE_SERVER);
            if(data) {
                const parsed = JSON.parse(data);
                state.orders = parsed.orders || [];
                state.nodes = parsed.nodes || [];
            }
        }

        function saveLocal() {
            localStorage.setItem(LOCAL_STORAGE_SERVER, JSON.stringify({
                orders: state.orders,
                nodes: state.nodes
            }));
        }

        async function syncPull() {
            const bar = document.getElementById('sync-progress');
            if(bar) bar.style.width = '40%';
            
            try {
                const res = await fetch(CLOUD_API);
                if(res.ok) {
                    const data = await res.json();
                    state.orders = data.orders || [];
                    state.nodes = data.nodes || [];
                    saveLocal(); // Local acts as secondary mirror
                    render();
                }
            } catch(e) { console.warn("Cloud Sync Offline. Local Server active."); }
            finally { 
                if(bar) { bar.style.width = '100%'; setTimeout(() => bar.style.width = '0%', 400); }
                const timeLabel = document.getElementById('sync-time');
                if(timeLabel) timeLabel.innerText = 'Last Sync: ' + new Date().toLocaleTimeString();
            }
        }

        async function syncPush() {
            saveLocal(); // Always write to local storage first (acts as internal server)
            try {
                await fetch(CLOUD_API, {
                    method: 'POST',
                    body: JSON.stringify({ orders: state.orders, nodes: state.nodes })
                });
            } catch(e) { console.error("Cloud Push Error"); }
        }

        async function heartbeat() {
            if(state.isAdmin) return;
            const idx = state.nodes.findIndex(n => n.id === state.myNodeId);
            const now = Date.now();
            const dev = navigator.userAgent.includes("Mobile") ? "Phone" : "Desktop";
            
            if(idx === -1) {
                state.nodes.unshift({ id: state.myNodeId, last: now, device: dev });
                await syncPush();
            } else {
                state.nodes[idx].last = now;
                if(now % 10 === 0) await syncPush(); 
            }
        }

        // --- RENDERERS ---

        function render() {
            if(state.isAdmin) renderAdmin();
            renderCustomer();
        }

        function renderCustomer() {
            const history = document.getElementById('cust-history');
            const nodeLabel = document.getElementById('node-label');
            if(nodeLabel) nodeLabel.innerText = `MY ID: ${state.myNodeId}`;

            const myOrders = state.orders.filter(o => o.node === state.myNodeId);
            if(history) {
                if(myOrders.length === 0) {
                    history.innerHTML = '<div class="py-20 text-center opacity-20"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i><p class="font-bold uppercase text-[10px]">Hakuna Historia</p></div>';
                } else {
                    history.innerHTML = '';
                    myOrders.forEach(o => {
                        const div = document.createElement('div');
                        div.className = "p-6 glass-card border-slate-100 flex justify-between items-center animate-in slide-in-from-right duration-300";
                        div.innerHTML = `
                            <div class="space-y-1">
                                <p class="text-[10px] font-black text-slate-400 uppercase">${o.plan} â€¢ ${o.date}</p>
                                <h5 class="text-2xl font-black text-blue-600">${o.voucher || 'Mchakato...'}</h5>
                                ${o.ip ? `<p class="text-[10px] font-mono text-emerald-600 font-bold tracking-widest">Router IP: ${o.ip}</p>` : ''}
                            </div>
                            <div class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase ${o.status === 'approved' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-50 text-blue-600'}">
                                ${o.status}
                            </div>
                        `;
                        history.appendChild(div);
                    });
                }
            }
            lucide.createIcons();
        }

        function renderAdmin() {
            // Summary Stats
            document.getElementById('stat-rev').innerText = `Tsh ${state.orders.filter(o => o.status === 'approved').reduce((a, b) => a + b.price, 0).toLocaleString()}`;
            document.getElementById('stat-pending').innerText = state.orders.filter(o => o.status === 'pending').length;
            document.getElementById('stat-online').innerText = state.nodes.filter(n => (Date.now() - n.last) < 40000).length;
            document.getElementById('stat-total').innerText = state.nodes.length;

            // Orders Table
            const list = document.getElementById('adm-orders');
            if(list) {
                list.innerHTML = '';
                state.orders.forEach(o => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50/50 transition-all border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="px-8 py-6">
                            <div class="font-black text-slate-900">${o.name}</div>
                            <div class="text-[10px] font-mono text-slate-400 mt-1">${o.node}</div>
                        </td>
                        <td class="px-8 py-6">
                            <span class="px-4 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-black uppercase tracking-widest">${o.plan}</span>
                            <div class="text-[11px] font-bold text-slate-900 mt-1">Tsh ${o.price.toLocaleString()}</div>
                        </td>
                        <td class="px-8 py-6">
                            <div class="text-[12px] font-black text-slate-700">${o.phone}</div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase mt-0.5">Sajili: ${o.regName}</div>
                        </td>
                        <td class="px-8 py-6 text-right">
                            ${o.status === 'pending' ? 
                                `<button onclick="approveOrder(${o.id})" class="px-6 py-3 bg-emerald-600 text-white text-[10px] font-black uppercase rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition-all">Approve & SMS</button>` :
                                `<div class="flex flex-col items-end">
                                    <span class="text-[10px] font-black text-emerald-600 uppercase">Vocha: ${o.voucher}</span>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase mt-1">Sent to ${o.phone}</span>
                                </div>`
                            }
                        </td>
                    `;
                    list.appendChild(tr);
                });
            }

            // User Nodes List
            const nodes = document.getElementById('adm-nodes');
            if(nodes) {
                nodes.innerHTML = '';
                state.nodes.forEach(n => {
                    const active = (Date.now() - n.last) < 40000;
                    const div = document.createElement('div');
                    div.className = "p-5 glass-card border-none flex items-center justify-between group hover:bg-slate-50 transition-all cursor-pointer";
                    div.onclick = () => openManualSMS(n.id);
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-3 h-3 rounded-full ${active ? 'bg-emerald-500 pulse-green' : 'bg-slate-300'}"></div>
                            <div>
                                <p class="text-xs font-black text-slate-900">${n.id}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">${n.device}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-[10px] font-bold text-slate-400">${new Date(n.last).toLocaleTimeString()}</div>
                            <i data-lucide="mail" class="w-4 h-4 text-blue-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                        </div>
                    `;
                    nodes.appendChild(div);
                });
            }
            lucide.createIcons();
        }

        // --- GLOBAL ACTIONS ---

        window.switchView = (v) => {
            document.getElementById('view-portal').classList.toggle('hidden', v !== 'portal');
            document.getElementById('view-admin').classList.toggle('hidden', v !== 'admin');
            document.getElementById('nav-portal').classList.toggle('active', v === 'portal');
            document.getElementById('nav-admin').classList.toggle('active', v === 'admin');
            syncPull();
        };

        window.openPayment = (plan, price) => {
            state.currentPlan = { plan, price };
            document.getElementById('pay-amount').innerText = 'Tsh ' + price.toLocaleString();
            document.getElementById('modal-pay').classList.remove('hidden');
        };

        window.closePayment = () => document.getElementById('modal-pay').classList.add('hidden');

        window.sendOrder = async () => {
            const name = document.getElementById('p-name').value;
            const phone = document.getElementById('p-phone').value;
            const regName = document.getElementById('p-regname').value;
            
            if(!name || !phone || !regName) return alert("Tafadhali jaza majina na namba ya malipo!");

            const order = {
                id: Date.now(),
                node: state.myNodeId,
                name, phone, regName,
                plan: state.currentPlan.plan,
                price: state.currentPlan.price,
                status: 'pending',
                date: new Date().toLocaleDateString(),
                voucher: null, ip: null
            };

            state.orders.unshift(order);
            await syncPush();
            closePayment();
            alert("Ombi lako limefika kwa Jeff. Vocha itatumwa kwa SMS kwenye namba " + phone + " punde akiona muamala.");
        };

        window.approveOrder = async (id) => {
            const idx = state.orders.findIndex(o => o.id === id);
            if(idx !== -1) {
                const voucher = 'JEFF-' + Math.floor(10000 + Math.random() * 89999);
                state.orders[idx].status = 'approved';
                state.orders[idx].voucher = voucher;
                state.orders[idx].ip = `10.10.8.${Math.floor(Math.random() * 250) + 10}`;
                
                await syncPush();
                
                // Trigger Simulated SMS
                const toast = document.getElementById('toast-sms');
                const msg = document.getElementById('sms-msg');
                msg.innerText = `Vocha ${voucher} imetumwa kwenda namba ${state.orders[idx].phone}!`;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 6000);
                
                renderAdmin();
            }
        };

        // Manual SMS Feature
        window.openManualSMS = (nodeId) => {
            document.getElementById('manual-node-id').innerText = nodeId;
            document.getElementById('modal-manual-sms').classList.remove('hidden');
        };

        window.closeManualSMS = () => document.getElementById('modal-manual-sms').classList.add('hidden');

        window.sendManualSMS = () => {
            const phone = document.getElementById('manual-phone').value;
            const msg = document.getElementById('manual-msg').value;
            if(!phone || !msg) return alert("Weka namba na ujumbe.");
            
            const toast = document.getElementById('toast-sms');
            document.getElementById('sms-msg').innerText = `Manual SMS imetumwa kwenda ${phone}!`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 6000);
            closeManualSMS();
        };

        window.doLogin = () => {
            const u = document.getElementById('adm-user').value.toLowerCase().trim();
            const p = document.getElementById('adm-pass').value;
            if(u === 'jeff' && p === 'mtaani') {
                state.isAdmin = true;
                sessionStorage.setItem('jeff_v5_auth', 'true');
                document.getElementById('admin-lock').classList.add('hidden');
                document.getElementById('admin-main').classList.remove('hidden');
                syncPull();
            } else {
                alert("Security Error: Jeff pekee ndio mwenye ufunguo huu.");
            }
        };

        window.doLogout = () => {
            sessionStorage.clear();
            location.reload();
        };

        window.connectNow = () => {
            const val = document.getElementById('v-input').value;
            if(!val) return alert("Andika namba ya vocha uliyopewa.");
            alert("Umeshajiunga! Sasa unafurahia Jeff WiFi kasi ya ajabu.");
        };

        // --- START SYSTEM ---
        loadLocal();
        if(state.isAdmin) {
            document.getElementById('admin-lock').classList.add('hidden');
            document.getElementById('admin-main').classList.remove('hidden');
            document.getElementById('nav-admin').classList.add('active');
            document.getElementById('nav-portal').classList.remove('active');
            document.getElementById('view-portal').classList.add('hidden');
            document.getElementById('view-admin').classList.remove('hidden');
        }

        syncPull();
        setInterval(syncPull, 6000); // Global cloud sync
        setInterval(heartbeat, 12000);
        lucide.createIcons();

    </script>
</body>
</html>